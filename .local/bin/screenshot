#!/bin/bash

select_geometry=$XDG_BIN_HOME/select-geometry

SCREENSHOT_PATH="$HOME"/pictures/screenshots
FILENAME=$(date +%Y%m%d_%H%M%S)
FORMAT="png"
COPY_TO_CLIPBOARD=false
METHOD=""

take_screenshot() {
	local file="$SCREENSHOT_PATH/$FILENAME.$FORMAT"
	local -r geometry="$1"

	if [[ ! -d $SCREENSHOT_PATH ]]; then
		mkdir -p "$SCREENSHOT_PATH"
	fi

	if [[ -z $geometry ]]; then
		sleep 0.5
		grim "$file"
	else
		sleep 0.5
		grim -g "$geometry" "$file"
	fi

	if $COPY_TO_CLIPBOARD; then
		wl-copy -t image/png <"$file"
	fi
}

sceeenshot_window() {
	geometry=$($select_geometry -w)

	if [[ -z $geometry ]]; then
		exit 1
	fi

	take_screenshot "$geometry"
}

screenshot_monitor() {
	geometry=$($select_geometry -m)

	if [[ -z $geometry ]]; then
		exit 1
	fi

	take_screenshot "$geometry"
}

screenshot_any() {
	geometry=$($select_geometry -a)

	if [[ -z $geometry ]]; then
		exit 1
	fi

	take_screenshot "$geometry"
}

screenshot_everything() {
	take_screenshot
}

display_help() {
	printf "Usage: screenshot [OPTIONS]\n"
	printf "Take a screenshot.\n\n"
	printf "Options:\n"
	printf "  -w, --window               Select a window to screenshot\n"
	printf "  -m, --monitor              Select a monitor to screenshot\n"
	printf "  -a, --any                  Select any region to screenshot\n"
	printf "  -e, --everything           Screenshot everything\n"
	printf "  -p, --path PATH            Set the path to save the screenshot\n"
	printf "  -f, --filename FILENAME    Set the filename of the screenshot\n"
	printf "  -c, --copy                 Copy to clipboard\n"
	printf "  -h, --help                 Display this help and exit\n\n"
}

if [ "$#" -eq 0 ]; then
	display_help
	exit 1
fi

options=$(getopt -o wmaep:f:ch --long window,monitor,any,everything,path:,filename:,copy,help -n "screenshot" -- "$@")
eval set -- "$options"
while true; do
	case "$1" in
	-w | --window)
		METHOD="window"
		shift
		;;
	-m | --monitor)
		METHOD="monitor"
		shift
		;;
	-a | --any)
		METHOD="any"
		shift
		;;
	-e | --everything)
		METHOD="everything"
		shift
		;;
	-p | --path)
		SCREENSHOT_PATH="$2"
		shift 2
		;;
	-f | --filename)
		FILENAME="$2"
		shift 2
		;;
	-c | --copy)
		COPY_TO_CLIPBOARD=true
		shift
		;;
	-h | --help)
		display_help
		exit 0
		;;
	--)
		shift
		break
		;;
	*)
		echo "Invalid option: $1"
		exit 1
		;;
	esac
done

case $METHOD in
window) sceeenshot_window ;;
monitor) screenshot_monitor ;;
any) screenshot_any ;;
everything) screenshot_everything ;;
esac
