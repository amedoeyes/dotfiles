#!/bin/bash

source "$XDG_BIN_HOME"/pactl_helpers.sh

DEVICE=""
TOGGLE=false
INCREMENT=false
INCREMENT_VALUE=""
DECREMENT=false
DECREMENT_VALUE=""
NOTIFY=false

get_icon_prefix() {
	if [[ $DEVICE == "sink" ]]; then
		printf "audio-volume"
	elif [[ $DEVICE == "source" ]]; then
		printf "microphone-sensitivity"
	else
		printf "Invalid device: %s\n" "$DEVICE" >&2
		exit 1
	fi
}

get_icon() {
	local -r icon_prefix=$(get_icon_prefix)
	local volume="$1"

	if "$(get_mute "$DEVICE")"; then
		printf "%s-muted-symbolic" "$icon_prefix"
		return
	fi

	if ((volume >= 66)); then
		printf "%s-high-symbolic" "$icon_prefix"
	elif ((volume >= 33)); then
		printf "%s-medium-symbolic" "$icon_prefix"
	elif ((volume >= 0)); then
		printf "%s-low-symbolic" "$icon_prefix"
	fi
}

increment() {
	set_volume $DEVICE "$INCREMENT_VALUE" +
}

decrement() {
	set_volume $DEVICE "$DECREMENT_VALUE" -
}

toggle() {
	set_mute $DEVICE toggle
}

notify() {
	local -r volume=$(get_volume "$DEVICE")
	local -r icon=$(get_icon "$volume")

	dunstify "Volume $volume%" -i "$icon" -u low -t 2000 -h int:value:"$volume" -r 999
}

display_help() {
	printf "Usage: %s [DEVICE] [OPTION]...\n" "$0"
	printf "Control audio input and output devices.\n\n"
	printf "Options:\n"
	printf "  -i, --input [OPTION]...    Control audio input device\n"
	printf "  -o, --output [OPTION]...   Control audio output device\n"
	printf "  -h, --help                 Display this help and exit\n\n"
	printf "Device options:\n"
	printf "  -t, --toggle               Toggle mute\n"
	printf "  -i, --increment [VALUE]    Increment volume by VALUE\n"
	printf "  -d, --decrement [VALUE]    Decrement volume by VALUE\n"
	printf "  -n, --notify               Display volume notification\n\n"
}

device_help() {
	local flag=""
	local device=""
	if [[ $DEVICE == "sink" ]]; then
		flag="-o, --output"
		device="output"
	elif [[ $DEVICE == "source" ]]; then
		flag="-i, --input"
		device="input"
	fi

	printf "Usage: %s %s [OPTION]...\n" "$0" "$flag"
	printf "Control %s audio device\n\n" "$device"
	printf "Options:\n"
	printf "  -t, --toggle               Toggle mute\n"
	printf "  -i, --increment [VALUE]    Increment volume by VALUE\n"
	printf "  -d, --decrement [VALUE]    Decrement volume by VALUE\n"
	printf "  -n, --notify               Display volume notification\n\n"
}

handle_device() {
	local -r options=$(getopt -o ti:d:nh --long toggle,increment:,decrement:,notify,help -- "$@")
	eval set -- "$options"
	while true; do
		case "$1" in
		-t | --toggle)
			TOGGLE=true
			shift
			;;
		-i | --increment)
			INCREMENT=true
			INCREMENT_VALUE="$2"
			shift 2
			;;
		-d | --decrement)
			DECREMENT=true
			DECREMENT_VALUE="$2"
			shift 2
			;;
		-n | --notify)
			NOTIFY=true
			shift
			;;
		-h | --help)
			device_help
			exit 0
			;;
		--)
			shift
			break
			;;
		*)
			echo "Invalid option: $1" >&2
			exit 1
			;;
		esac
	done
}

options=$(getopt -o ioh --long input,output,help -- "$1")
while true; do
	case "$1" in
	-i | --input)
		DEVICE="source"
		shift
		handle_device "$@"
		break
		;;
	-o | --output)
		DEVICE="sink"
		shift
		handle_device "$@"
		break
		;;
	-h | --help)
		display_help
		exit 0
		;;
	*)
		echo "Invalid option: $1" >&2
		exit 1
		;;
	esac
done

if $TOGGLE; then
	toggle
fi

if $INCREMENT; then
	increment
fi

if $DECREMENT; then
	decrement
fi

if $NOTIFY; then
	notify
fi
